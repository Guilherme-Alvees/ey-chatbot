<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EY Chatbot - Teste Local</title>
    <style>
    .chatbot-container {
        font-family: 'Segoe UI', Arial, sans-serif;
        display: flex;
        flex-direction: column;
        height: 500px;
        width: 350px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin: 20px auto;
    }
    
    .chatbot-header {
        padding: 16px;
        background-color: #0072CE;
        color: white;
        font-weight: bold;
        font-size: 16px;
    }
    
    .chatbot-messages {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
        background-color: #f9f9f9;
    }
    
    .message {
        max-width: 80%;
        margin-bottom: 12px;
        padding: 10px 14px;
        border-radius: 18px;
        line-height: 1.4;
        font-size: 14px;
    }
    
    .bot-message {
        background-color: #e0e0e0;
        color: #000;
        align-self: flex-start;
        border-bottom-left-radius: 4px;
    }
    
    .user-message {
        background-color: #0072CE;
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
        margin-left: auto;
    }
    
    .error-message {
        background-color: #ffebee;
        color: #c62828;
        border: 1px solid #ef9a9a;
    }
    
    .chatbot-input {
        display: flex;
        padding: 12px;
        border-top: 1px solid #e0e0e0;
        background-color: #fff;
    }
    
    .chatbot-input input {
        flex: 1;
        padding: 10px 14px;
        border: 1px solid #ddd;
        border-radius: 20px;
        outline: none;
        font-size: 14px;
    }
    
    .chatbot-input button {
        margin-left: 8px;
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 50%;
        background-color: #0072CE;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .chatbot-input button:hover {
        background-color: #005fa3;
    }
    
    .loading-message {
        color: #666;
        font-style: italic;
    }
    
    .retry-button {
        color: #0072CE;
        text-decoration: underline;
        cursor: pointer;
        margin-left: 5px;
    }
    
    .solution-selector {
        padding: 10px;
        text-align: center;
        background: #f5f5f5;
    }
    
    .solution-selector select {
        padding: 5px;
        border-radius: 4px;
        border: 1px solid #ddd;
    }
    </style>
</head>
<body>
    <div class="solution-selector">
        <label for="cors-solution">Escolha a solução CORS:</label>
        <select id="cors-solution">
            <option value="proxy">Usar Proxy CORS</option>
            <option value="server">Configuração de Servidor</option>
            <option value="extension">Extensão do Navegador</option>
        </select>
    </div>

    <div class='chatbot-container'>
        <div class='chatbot-header'>
            <h3>EY Chatbot</h3>
        </div>
        <div class='chatbot-messages' id='messageContainer'>
            <div class='message bot-message'>
                Olá! Sou o chatbot de dados. Como posso ajudar?
            </div>
        </div>
        <div class='chatbot-input'>
            <input type='text' id='userInput' placeholder='Send a message...' />
            <button id='sendButton'>
                <svg viewBox='0 0 24 24' width='20' height='20'>
                    <path fill='currentColor' d='M2.01 21L23 12 2.01 3 2 10l15 2-15 2z'></path>
                </svg>
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');
            const messageContainer = document.getElementById('messageContainer');
            const corsSolution = document.getElementById('cors-solution');
            
            function addMessage(text, isUser, isError = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = isUser ? 'message user-message' : 
                                        isError ? 'message error-message' : 'message bot-message';
                messageDiv.textContent = text;
                messageContainer.appendChild(messageDiv);
                messageContainer.scrollTop = messageContainer.scrollHeight;
                return messageDiv;
            }
            
            function showLoading() {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'message bot-message loading-message';
                loadingDiv.textContent = 'Processando sua pergunta...';
                loadingDiv.id = 'loadingMessage';
                messageContainer.appendChild(loadingDiv);
                messageContainer.scrollTop = messageContainer.scrollHeight;
                return loadingDiv;
            }
            
            function hideLoading() {
                const loadingDiv = document.getElementById('loadingMessage');
                if (loadingDiv) loadingDiv.remove();
            }
        
            async function callApiWithProxy(message) {
                // Solução 1: Usar um proxy CORS público
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const apiUrl = 'https://chatbot-api-hs3febfij-guilhermealvees-projects.vercel.app/consultar';
                
                const response = await fetch(proxyUrl + apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest' // Necessário para alguns proxies
                    },
                    body: JSON.stringify({ pergunta: message })
                });
                return response;
            }
            
            async function callApiDirectly(message) {
                // Solução 2: Chamada direta (requer CORS configurado no servidor)
                const response = await fetch('https://chatbot-api-hs3febfij-guilhermealvees-projects.vercel.app/consultar', {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ pergunta: message })
                });
                return response;
            }
            
            async function callApiWithExtension(message) {
                // Solução 3: Para uso com extensão CORS
                // Esta abordagem só funciona se você tiver uma extensão CORS instalada
                const response = await fetch('https://chatbot-api-hs3febfij-guilhermealvees-projects.vercel.app/consultar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ pergunta: message })
                });
                return response;
            }
            
            async function sendMessage() {
                const message = userInput.value.trim();
                if (!message) return;
                
                addMessage(message, true);
                userInput.value = '';
                userInput.disabled = true;
                sendButton.disabled = true;
                
                const loadingDiv = showLoading();
                
                try {
                    let response;
                    const solution = corsSolution.value;
                    
                    // Seleciona a estratégia baseada na escolha do usuário
                    switch(solution) {
                        case 'proxy':
                            response = await callApiWithProxy(message);
                            break;
                        case 'server':
                            response = await callApiDirectly(message);
                            break;
                        case 'extension':
                            response = await callApiWithExtension(message);
                            break;
                        default:
                            throw new Error('Solução CORS não selecionada');
                    }
                    
                    // Processa a resposta
                    const text = await response.text();
                    let data;
                    try {
                        data = text ? JSON.parse(text) : {};
                    } catch (e) {
                        throw new Error('Resposta da API em formato inválido');
                    }
                    
                    if (!response.ok) {
                        throw new Error(data.message || `Erro HTTP: ${response.status}`);
                    }
                    
                    if (!data.resposta) {
                        throw new Error('Resposta da API não contém o campo esperado');
                    }
                    
                    hideLoading();
                    addMessage(data.resposta, false);
                    
                } catch (error) {
                    console.error('Erro detalhado:', error);
                    hideLoading();
                    
                    let errorMessage = 'Ocorreu um erro ao processar sua solicitação. ';
                    
                    if (error.message.includes('Failed to fetch')) {
                        errorMessage = `Problema de CORS detectado. Solução atual: ${corsSolution.options[corsSolution.selectedIndex].text}. `;
                        errorMessage += 'Tente outra abordagem ou configure o servidor.';
                    } else if (error.message.includes('Resposta da API')) {
                        errorMessage = 'O servidor retornou uma resposta inesperada.';
                    }
                    
                    const errorDiv = addMessage(errorMessage, false, true);
                    
                    const retrySpan = document.createElement('span');
                    retrySpan.className = 'retry-button';
                    retrySpan.textContent = 'Tentar novamente';
                    retrySpan.onclick = sendMessage;
                    errorDiv.appendChild(retrySpan);
                    
                } finally {
                    userInput.disabled = false;
                    sendButton.disabled = false;
                    userInput.focus();
                }
            }
            
            sendButton.addEventListener('click', sendMessage);
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Adiciona mensagem explicativa sobre CORS
            addMessage('Dica: Selecione a solução CORS adequada no menu acima', false);
        });
    </script>
</body>
</html>